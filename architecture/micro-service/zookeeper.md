# ZooKeeper
[参考文档](https://segmentfault.com/a/1190000016349824)
- 开源的分布式协调服务
- 典型的分布式数据一致性解决方案
    + 数据发布/订阅
    + 负载均衡
    + 命名服务
    + 分布式协调/通知
    + 集群管理
    + Master选举
    + 分布式锁
    + 分布式队列
- 常用场景是：作为服务生产者和服务消费者的注册中心

## 重要概念
- 本身是一个分布式程序，只要有半数以上节点存活，就能正常服务
- 最好以集群形态来部署服务，以保证高可用
- 将数据保存在内存中，保证了高吞吐量及低延迟
- 高性能，适合多于写的应用，因为写会导致所有服务器间的同步
- 有临时节点的概念，会话终结时会被删除；而持久节点会一直存在
- 底层只提供两个功能：
    + 存储/读取用户程序提交的数据
    + 为用户程序提交数据节点监听服务

## 会话
- 客户端与服务器连接后，会建立一个tcp长连接，
- 基于长连接，客户端可以通过心跳检测与服务器保持有效会话及接收服务器的watch事件通知
- 服务端会为每个客户端分配一个保证全局唯一的sessionID

## Znode
- 数据节点，数据模型中的数据单元
- 数据存储在内存中
- 树形结构（tree）,由斜杠进行路径分割

## 版本
- 为每个Znode维护一个叫做Stat的数据结构,记录了三个版本
    + 当前Znode版本
    + 当前Znode子节点的版本
    + 当前Znode的ACL版本

## watcher
- 事件监听器，允许用户在每Znode节点上注册一些watcher,并在一些特定事件触发的时候将事件通知到感兴趣的客户端上
- 该机制是ZooKeeper实现分布式协调服务的重要特性

## ACL
- 采用AccessControlLists策略来进行权限控制，类似于unix文件系统的权限控制
- 5种权限
    + create: 创建`子`节点
    + read: 读取节点数据和节点列表
    + write: 更新节点数据
    + delete: 删除`子`节点
    + admin: 设置节点的ACL

## 特点
- 顺序一致性：客户端发起的事务请求严格按照顺序被应用到服务中去
- 原子性：所有事务请求的结果在整个集群中是一致的
- 单一系统映像：无论客户连接到哪个节点服务器，看到的数据都是一致的
- 可靠性：更改结果持久化

## 设计目标
- 简单的数据模型：通过共享层次结构命名空间进行相互协调，与标准文件系统类型
- 可构建集群
- 顺序访问
- 高性能

## 角色
- leader: 领导者，负责进行投票的发起和决议，更新系统状态 
- follower: 跟随者，接收客户端请求并向客户端返回结果，在选主过程中参与投票
- observer: 观察者，接收客户端连接，将写请求转发给leader节点，但不参与投票，只同步leader的状态。目的是为了扩展系统，提供读取速度
- client: 客户端，服务发起方

## ZAB协议（ZooKeeper Atomic Broadcast原子广播协议）
- 为分布式协调服务ZooKeeper专门设计的一种支持崩溃恢复的原子广播协议，实现分布式数据一致性
- 两种基本的模式：崩溃恢复和消息广播
- 当集群中已经有过半的Follower服务器完成了和Leader服务器的状态同步，那么整个服务框架就可以进人消息广播模式了。









